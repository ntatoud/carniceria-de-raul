<!-- views/payment.ejs -->

<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Title -->
  <title>Order - Raul's butcher shop</title>

  <%- include('../../../imports.ejs') %>
  <link
      rel="stylesheet"
      type="text/css"
      href="/css/layout/orderNav.css"
  />
  <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <header><%- include('./layout/layout.ejs') %></header>
    <main>payment <%- include('../orderNav.ejs') %>
    <%-include('../scripts.ejs')%>
  <form class="d-flex flex-column align-items-center" id="payment-form">
    <div>
      <label for="card-number">Card Number</label>
      <div id="card-element-number"></div>
    </div>

    <div>
      <label for="card-expiry">Card Expiry</label>
      <div id="card-element-expiry"></div>
    </div>

    <div>
      <label for="card-cvc">Card CVC</label>
      <div id="card-element-cvc"></div>
    </div>

    <div id="card-errors" role="alert"></div>

    <button id="checkout-button">Pagar</button>
  </form>

  <script>
    var stripe = Stripe('pk_test_51OS0DKLo0ku5dcyT0us7OYDfQDxij6p5OQE2slRwBWC8JPv3ioA7cWS78SFVPk8CPHAOYjHJAiFUcKtG4vfbMPA700ficXGIez');
    var elements = stripe.elements();

    // Create an instance of the card Element for Card Number.
    var cardNumber = elements.create('cardNumber');
    cardNumber.mount('#card-element-number');

    // Create an instance of the card Element for Card Expiry.
    var cardExpiry = elements.create('cardExpiry');
    cardExpiry.mount('#card-element-expiry');

    // Create an instance of the card Element for Card CVC.
    var cardCvc = elements.create('cardCvc');
    cardCvc.mount('#card-element-cvc');

    // Handle real-time validation errors from the card Elements.
    cardNumber.addEventListener('change', handleCardChange);
    cardExpiry.addEventListener('change', handleCardChange);
    cardCvc.addEventListener('change', handleCardChange);

    // Function to handle real-time validation errors
    function handleCardChange(event) {
      var displayError = document.getElementById('card-errors');
      if (event.error) {
        displayError.textContent = event.error.message;
      } else {
        displayError.textContent = '';
      }
    }

    // Create a token or display an error when the form is submitted.
    var form = document.getElementById('payment-form');
    form.addEventListener('submit', function(event) {
      event.preventDefault();

      // TODO: Implement logic to handle payment
      // ...
      var cardNumber = document.getElementById('card-number').value;

      stripe.createPaymentMethod({
        type: 'card',
        card: cardNumb0er,
      }).then(function(result) {
        if (result.error) {
          handlePaymentError(result.error.message);
        } else {
          handlePaymentSuccess(result.paymentMethod.id);
        }
      });
    });

    // Function to handle payment error
    function handlePaymentError(errorMessage) {
      // TODO: Implement logic for payment error
      // ...
      console.error(errorMessage);

      console.error(`Payment error: ${errorMessage}`);
    }
    function handlePaymentSuccess(paymentMethodId) {
      // You now have the payment method ID, send it to your server
      // using AJAX/fetch to process the payment on the server side
      // and create a PaymentIntent or perform other necessary actions
      // Example AJAX call to your server:
      fetch('/procesar-pago', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ paymentMethodId: paymentMethodId })
      })
      .then(response => {
        if (response.ok) {
          // Redirect to the shop page on successful payment
          window.location.href = '/shop'; // Replace '/shop' with your shop URL
        } else {
          // Handle server-side errors
          return response.json().then(data => {
            throw new Error(data.error.message);
          });
        }
      })
      .catch(error => {
        // Handle errors from the server or during the redirect
        console.error(error);
        // Display an error message or perform additional actions
      });
    }
  </script>
</main>
</body>
</html>
